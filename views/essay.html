<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Speakers</title>

</head>

<body>
  <h1>
    <%= title %>
  </h1>

  <script src="https://www.youtube.com/player_api"></script>

  <!-- <iframe id="video-player" width="560" height="315" src="https://www.youtube.com/embed/<%= videoId %>" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe> -->
  <iframe id="player" width="640" height="360" src="https://www.youtube.com/embed/<%= videoId %>?enablejsapi=1"
    frameborder="0" allowfullscreen=""></iframe>
    <h1>Enter the number of speakers</h1>
    <form>
      <textarea id="text" placeholder="Enter Text"></textarea>
      <input type="text" id="fileName" placeholder="Enter File Name">
      <input type="submit" value="Save &amp; Download" id="saveBtn">
      <input id="myFile" type="file"/>
    </form>
    <h1>Enter the number of speakers</h1>
    <form>
      <textarea id="text" placeholder="Enter Text"></textarea>
      <input type="text" id="fileName" placeholder="Enter File Name">
      <input type="submit" value="Save &amp; Download" id="saveBtn">
      <input id="myFile" type="file"/>
    </form>
    
  <h1>Enter the number of speakers</h1>

  <form id="speakerForm">
    <input type="number" id="speakerCount" name="speakerCount">
    <button type="submit">Submit</button>
  </form>

  <hr>
  <!-- <label for="numSpeakers">Number of Speakers:</label> -->
  <input type="number" id="numSpeakers" name="numSpeakers" value="2">
  <button id="createButtonsButton" onclick="createButtons();this.disabled=true;this.style.background='grey';">Create
    Buttons</button>

  <div id="buttons"></div>
  <div id="player"></div>

  <script>
let textEle = document.getElementById("text");
let fileNameEle = document.getElementById("fileName");
let saveBtn = document.getElementById("saveBtn");
let fileEle = document.getElementById("myFile");

fileEle.addEventListener("change", () => {
  const file = fileEle.files[0];
  const reader = new FileReader();
  reader.onload = (event) => {
    textEle.value = event.target.result;
  };
  reader.readAsText(file);
});

saveBtn.addEventListener("click", (e) => {
  e.preventDefault();
  const textData = textEle.value;
  const textDataBlob = new Blob([textEle.value], { type: "text/plain" });

  const downloadUrl = window.URL.createObjectURL(textDataBlob)

  const downloadLink = document.createElement('a');
  downloadLink.download = fileNameEle.value
  downloadLink.href = downloadUrl;
  downloadLink.click()

  console.log(textData);
  console.log(textDataBlob);
});
    var videoId = '3jaGhfeNqPM';
    var player;

    // When the YouTube API is ready, create the player
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        videoId: videoId,
        origin: "*",
        events: {
          'onReady': onPlayerReady
        }
      });
    }

    // When the player is ready, add the click event listener to the button
    function onPlayerReady(event) {
      var button = document.getElementById('buttons');
      button.addEventListener('click', function () {
        var currentTime = player.getCurrentTime();
        var timestamp = formatTime(currentTime);
        // alert('Current timestamp: ' + formattedTime);
      });
    }
    let question;
    let answer;
    function createButtons() {
      const numSpeakers = document.getElementById('numSpeakers').value;
      let buttonsHtml = '';
      let question = '';
      let answer = '';
      for (let i = 1; i <= numSpeakers; i++) {
        buttonsHtml += `
      <div>
        <label for="speakers${i}">Speaker ${i} Name:</label>
        <input type="text" id="speakers${i}" name="speakers${i}">
        <button onclick="getTimestamp(${i}, document.getElementById('speakers${i}').value)">Timestamp</button>
        <button onclick="event.preventDefault(); const question = prompt('Enter your question:'); getQuestionTimestamp(${i}, document.getElementById('speakers${i}').value)">Question</button>
        <button onclick="event.preventDefault(); const answer = prompt('Enter your answer:'); getAnswerTimestamp(${i}, document.getElementById('speakers${i}').value)">Answer</button>
       
      </div>
      <hr>
    `;
      }
      // <button onclick="getAnswerTimestamp(${i}, document.getElementById('speakers${i}').value)">Answer</button>
      document.getElementById('buttons').innerHTML = buttonsHtml;
      document.getElementById('numSpeakers').disabled = true;

      // Add event listeners to update the current time for each timestamp button
      const video = document.getElementById('video-player');
      const timestampButtons = document.querySelectorAll('.timestamp-button');
      timestampButtons.forEach(button => {
        button.addEventListener('click', () => {
          var currentTime = video.currentTime.toFixed(0);
          var timestamp = formatTime(currentTime);

          const videoId = button.getAttribute('data-video-id'); // Get the video ID from the data attribute of the button
          const speakerNumber = button.getAttribute('data-speaker');
          const speakerName = button.getAttribute('data-speaker-name');
          const filename = `${videoId}-${speakerName}`;
          const timestampFolder = 'speakerT.S';

          // Convert the timestamp to a human-readable format
          const convertedTimestamp = timestamp;

          // Create a new file to store the timestamp data if it does not exist
          createTimestampsFile(filename, timestampFolder);

          // Read existing timestamp data from the file
          const data = localStorage.getItem(`${timestampFolder}/${filename}`);
          const timestamps = JSON.parse(data) || [];

          // Add the new timestamp to the data array
          timestamps.push(convertedTimestamp);

          // Write the updated timestamp data to the file
          localStorage.setItem(`${timestampFolder}/${filename}`, JSON.stringify(timestamps));

          // Log a message to indicate success
          console.log(`New timestamp ${convertedTimestamp} added for ${speakerName} in video ${videoId}.`);

          // Clear the timestamp data attribute of the button
          button.setAttribute('data-timestamp', '');
        });
      });


    }




    function disableButton(btnId) {
      document.getElementById(btnId).disabled = true;
      document.getElementById(btnId).style.background = 'grey';
    }


    function getQuestionTimestamp(speakerNumber, speakerName) {
      var currentTime = player.getCurrentTime();
      var timestamp = formatTime(currentTime);
      var question = prompt("Enter your question:");
      console.log(`Speaker ${speakerNumber} question timestamp: ${question}  ${timestamp}`);
      // Send the question timestamp and question to the server to be saved
      fetch(`/api/question-timestamps/<%= videoId %>/${speakerName}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ timestamp, question })
      })
        .then(response => response.json())
        .then(data => console.log(data))
        .catch(error => console.error(error));
    }


    function getAnswerTimestamp(speakerNumber, speakerName) {
      var currentTime = player.getCurrentTime();
      var timestamp = formatTime(currentTime);
      var answer = prompt("Enter your answer:");
      console.log(`Speaker ${speakerNumber} answer timestamp: ${answer}  ${timestamp}`);
      // Send the question timestamp and question to the server to be saved
      fetch(`/api/answer-timestamps/<%= videoId %>/${speakerName}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ timestamp, question, answer })
      })
        .then(response => response.json())
        .then(data => console.log(data))
        .catch(error => console.error(error));
    }


    function getTimestamp(speakerNumber, speakerName) {
      // const timestamp = Date.now();
      var currentTime = player.getCurrentTime();
      var timestamp = formatTime(currentTime);
      console.log(`Speaker ${speakerNumber} timestamp: ${timestamp}`);
      // Send the timestamp to the server to be saved
      fetch(`/api/timestamps/<%= videoId %>/${speakerName}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ timestamp })
      })
        .then(response => response.json())
        .then(data => console.log(data))
        .catch(error => console.error(error));
    }

    function formatTime(time) {
      const hours = Math.floor(time / 3600);
      const minutes = Math.floor((time - hours * 3600) / 60);
      const seconds = Math.floor(time - hours * 3600 - minutes * 60);
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

  </script>
  <script>


  </script>
</body>

</html>